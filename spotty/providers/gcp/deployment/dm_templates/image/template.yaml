resources:
  - name: {{MACHINE_NAME}}
    type: compute.v1.instance
    properties:
      zone: {{ZONE}}
      machineType: zones/{{ZONE}}/machineTypes/{{MACHINE_TYPE}}
      scheduling:
        preemptible: {{PREEMPTIBLE}}
      serviceAccounts:
        - email: {{SERVICE_ACCOUNT_EMAIL}}
          scopes: ['https://www.googleapis.com/auth/cloud-platform']
      disks:
        - deviceName: boot
          type: PERSISTENT
          boot: true
          autoDelete: true
          initializeParams:
            diskName: {{MACHINE_NAME}}
            sourceImage: {{SOURCE_IMAGE}}
      networkInterfaces:
        - network: global/networks/default
          accessConfigs:
            - name: External NAT
              type: ONE_TO_ONE_NAT
      guestAccelerators:
        - acceleratorType: zones/{{ZONE}}/acceleratorTypes/{{GPU_TYPE}}
          acceleratorCount: {{GPU_COUNT}}
      metadata:
        items:
          - key: 'user-data'
            value: |
              {{{STARTUP_SCRIPT}}}

  - name: {{MACHINE_NAME}}-docker-status
    type: runtimeconfig.v1beta1.config
    properties:
      config: {{MACHINE_NAME}}-docker-status
      description: Docker status

  - name: {{MACHINE_NAME}}-image-status
    type: runtimeconfig.v1beta1.config
    properties:
      config: {{MACHINE_NAME}}-image-status
      description: Image status

  - name: {{MACHINE_NAME}}-docker-waiter
    type: runtimeconfig.v1beta1.waiter
    metadata:
      dependsOn:
        - {{MACHINE_NAME}}
    properties:
      parent: $(ref.{{MACHINE_NAME}}-docker-status.name)
      waiter: {{MACHINE_NAME}}-docker-waiter
      timeout: 1800s
      success:
        cardinality:
          path: /success
          number: 1
      failure:
        cardinality:
          path: /failure
          number: 1

  - name: {{MACHINE_NAME}}-image-waiter
    type: runtimeconfig.v1beta1.waiter
    metadata:
      dependsOn:
        - {{MACHINE_NAME}}-docker-waiter
    properties:
      parent: $(ref.{{MACHINE_NAME}}-image-status.name)
      waiter: {{MACHINE_NAME}}-image-waiter
      timeout: 1200s
      success:
        cardinality:
          path: /success
          number: 1
      failure:
        cardinality:
          path: /failure
          number: 1

  - name: {{MACHINE_NAME}}-image-status-success
    type: runtimeconfig.v1beta1.variable
    metadata:
      dependsOn:
        - {{MACHINE_NAME}}-image-waiter
    properties:
      parent: $(ref.{{MACHINE_NAME}}-image-status.name)
      variable: /success/1

  - name: {{IMAGE_NAME}}
    type: compute.v1.image
    metadata:
      dependsOn:
        - {{MACHINE_NAME}}-image-waiter
    properties:
      sourceImage: global/images/{{IMAGE_NAME}}

outputs:
  - name: imageId
    value: $(ref.{{MACHINE_NAME}}-image-status-success.text)
